<chapter xmlns="http://docbook.org/ns/docbook"
         xmlns:xi='http://www.w3.org/2001/XInclude'
         xmlns:xlink="http://www.w3.org/1999/xlink"
         xml:id="cf_modularity"
         version="5.2">
<info>
  <?db filename="modularity"?>
  <title>Modularity</title>
</info>

<para>Modularity is an experimental feature introduced in version 3.3.0. Itâ€™s
inspired by <link xlink:href="https://homepages.cwi.nl/~steven/Talks/2025/06-06-markupuk/paper.html">Modular
ixml</link> presented by Steven Pemberton at MarkupUK in 2025, but some of
the details are different. Itâ€™s likely, if the 
<link xlink:href="https://www.w3.org/community/ixml/">Community Group</link> continues
to work on modularity as a feature of iXML, that the design will change further.
Places where this design differs from the design presented in <citetitle>Modular ixml</citetitle>
are marked with â€œğŸ‘€â€ to draw your attention.
</para>

<para>The idea behind modularity is to enable reuse. As the number and
complexity of iXML grammars grows, good software design practice
encourages reusablity with a mechanism more reliable than
â€œcut-and-pasteâ€ between grammars.</para>

<para>Conceptually, modularity constructs a new (monolithic) grammar
that contains all of the necessary productions. It isnâ€™t a textual
inclusion of any kind. Grammars can use each other more-or-less arbitrarily.</para>

<para>Modularity extends the iXML grammar by adding <literal>uses</literal> and
<literal>shares</literal> elements. These extensions are introduced by a â€œ<code>+</code>â€
as shown in this example:</para>

<example xml:id="ex.mod.numerics">
<title>A modular grammar for numbers, <filename>numerics.ixml</filename></title>
<programlisting>+uses digit, hexdigit from "digits.ixml" .
+shares decimal, hexadecimal .

number = decimal | hexadecimal .

decimal = digit+ .
hexadecimal = hexdigit+ .</programlisting>
</example>

<para>The <literal>uses</literal> clause says that this grammar
<emphasis>uses</emphasis> the rules for <literal>digit</literal> and
<literal>hexdigit</literal> from the <filename>digits.ixml</filename>
grammar. It <emphasis>shares</emphasis> the rules for
<literal>decimal</literal> and <literal>hexadecimal</literal>.
</para>

<para>A grammar with an explicit shares clause is publishing its interface. Only
the explicitly shared symbols may be used by another grammar. If thereâ€™s no shares
clause, ğŸ‘€ any symbol may be used by another grammar.</para>

<para>The effect of requesting modularity is to ğŸ‘€ parse the input grammar against
a variant iXML grammar that includes the new features. The relevant
productions are:</para>

<programlisting>         ixml: s, (prolog, RS)?, ((uses; shares), RS)*, rule++RS, s.
         uses: -"+uses", RS, mfrom++(-";", s), s, -'.' .
       shares: -"+shares", RS, entries, s, -'.' .
   mfrom>from: entries, RS, -"from", RS, source .
     -entries: share++(-",", s).
        share: @name.
      @source: string .</programlisting>

<para>These changes allow optional <code>uses</code> and <code>shares</code>
statements to appear before the first rule. The ğŸ‘€ grammar URIs are quoted and
ğŸ‘€ each clause ends with a full stop.</para>

<para>It is an error to define a rule for a symobol that is used from another grammar.</para>

<para>It is an error to attempt to use a clause from another grammar if that grammar does
not share the symbol (or if no symbols are explicitly shared, if the grammar does not contain 
a rule the symbol).</para>

<para>To complete the example above, <filename>digits.ixml</filename> is shown in
<xref linkend="ex.mod.digits"/> and <filename>partno.ixml</filename> is show in
<xref linkend="ex.mod.partno"/>.</para>

<example xml:id="ex.mod.digits">
<title>A modular grammar for digits, <filename>digits.ixml</filename></title>
<programlisting>+shares digit, hexdigit .

-digit = ["0"-"9"] .
-hexdigit = digit | hexadecimal .
-hexadecimal = ["A"-"F" | "a"-"f" ] .</programlisting>
</example>

<example xml:id="ex.mod.partno">
<title>A modular grammar for part numbers, <filename>partno.ixml</filename></title>
<programlisting>+uses decimal from "numerics.ixml" .

partno: -decimal .</programlisting>
</example>

<para>Observe that the nonterminal <literal>hexadecimal</literal> is
used in two grammars and has different definitions. The processor is
responsible for making sure that a correct grammar is constructed. The
renaming feature, introduced recently in Invisible XML, allows the processor to rename
nonterminals while preserving the correct serialization.</para>

<para>The composed grammar is included in the debugging output, if the
modularity option is used:</para>

<programlisting language="xml"><![CDATA[<ixml>
   <rule name="partno">
      <alt>
         <nonterminal name="decimal" mark="-"/>
      </alt>
   </rule>
   <rule name="decimal">
      <alt>
         <repeat1>
            <nonterminal name="digit"/>
         </repeat1>
      </alt>
   </rule>
   <rule name="digit" mark="-">
      <alt>
         <inclusion>
            <member from="0" to="9"/>
         </inclusion>
      </alt>
   </rule>
</ixml>]]></programlisting>

</chapter>
