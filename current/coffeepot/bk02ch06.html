<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" class="no-js"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><script>(function(H){H.className=H.className.replace(/\bno-js\b/,'js')})(document.documentElement)</script><title>Chapter 6. Choosing among alternatives</title><link href="../css/prism.css" rel="stylesheet"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link href="https://purl.org/dc/elements/1.1/" rel="schema.dc"/><meta name="dc.modified" content="2025-02-23T08:59:33Z"/><meta name="generator" content="DocBook xslTNG version 2.4.1 / 5e956019 / SAXON HE 12.3"/><link href="../css/docbook-toc.css" rel="stylesheet"/><script src="../js/prism.js"></script><link href="../css/docbook.css" rel="stylesheet" media="screen"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><script src="https://kit.fontawesome.com/498b6706f0.js" type="text/javascript" crossorigin="anonymous"></script><link href="../css/coldark-cold.css" rel="stylesheet"/><link href="../css/nineml.css" rel="stylesheet"/><link href="../css/ninemlset.css" rel="stylesheet"/><link href="../icon/nineml.png" rel="shortcut icon"/><link rel="prev" href="bk02ch05.html"/><link rel="next" href="bk02ch07.html"/><link rel="up" href="index.html"/><link rel="home" href="../index.html"/><script src="../js/persistent-toc.js" defer="defer"></script><script src="../js/copy-verbatim.js" defer="defer"></script><script src="../js/chunk-nav.js" defer="defer"></script><link href="../icon/CoffeePot.png" rel="shortcut icon"/><link href="../css/coffeepot.css" rel="stylesheet"/></head><body class="chapter component"><nav class="top"><span class="nav"><a title="" href="../index.html"><i class="fas fa-home"></i></a> <a title="Chapter 5. Ambiguity" href="bk02ch05.html"><i class="fas fa-arrow-left"></i></a> <a title="CoffeePot" href="index.html"><i class="fas fa-arrow-up"></i></a> <a title="Chapter 7. Configuration" href="bk02ch07.html"><i class="fas fa-arrow-right"></i></a></span><span class="title"><i class="title">NineML</i></span></nav><main><section id="choose-alternative" db-chunk="bk02ch06.html" db-id="d493e1713" class="chapter component"><header><h2>Chapter <span class="label">6</span><span class="sep">. </span>Choosing among alternatives</h2></header><div class="db-bfs">


<p>Where it’s practical to write a grammar that is unambiguous,
that’s best. But it isn’t always practical. Sometimes it’s difficult,
and sometimes it’s impossible. If the data is actually ambiguous, you
may have to reflect that in your grammar.</p>

<p>Invisible XML doesn’t consider ambiguity an error, but it also
doesn’t provide any mechanism for controlling it. All parses are
considered equal and the processor’s only obligation is to provide one
of them.</p>

<p>Consider this simple, ambiguous grammar:</p>

<div class="pre-wrap programlisting-wrap"><pre class="language-ixml programlisting verbatim"><code>   number-list = (number, -#a)+, number? .
        number = hex | decimal .
           hex = hex-digit+ .
       decimal = decimal-digit+ .
    -hex-digit = ["0"-"9" | "a"-"f" | "A"-"F" ] .
-decimal-digit = ["0"-"9" ] .
</code></pre></div>

<p>If we parse the following input,</p>

<div class="pre-wrap programlisting-wrap"><pre class="language-none programlisting verbatim"><code>bad
cafe
42</code></pre></div>

<p>We might get this result:</p>

<div class="pre-wrap programlisting-wrap"><pre class="language-xml programlisting verbatim"><code>&lt;number-list xmlns:ixml="http://invisiblexml.org/NS" ixml:state="ambiguous"&gt;
  &lt;hex&gt;bad&lt;/hex&gt;
  &lt;hex&gt;cafe&lt;/hex&gt;
  &lt;hex&gt;42&lt;/hex&gt;
&lt;/number-list&gt;</code></pre></div>

<p>Of course, we might equally get this result:</p>

<div class="pre-wrap programlisting-wrap"><pre class="language-xml programlisting verbatim"><code>&lt;number-list xmlns:ixml="http://invisiblexml.org/NS" ixml:state="ambiguous"&gt;
  &lt;hex&gt;bad&lt;/hex&gt;
  &lt;hex&gt;cafe&lt;/hex&gt;
  &lt;decimal&gt;42&lt;/decimal&gt;
&lt;/number-list&gt;</code></pre></div>

<p>The ambiguity here is between “decimal” and “hexadecimal”. You
may wish to control which one is selected. CoffeePot provides two ways
to examine the alternatives and select one: you can provide a function
library that defines
<a href="https://coffeesacks.nineml.org/ch07.html" class="link">a
function</a> that chooses between them, or you can provide a list
of XPath expressions to select an alternative. Using a function
library requires Saxon PE or Saxon EE.</p>

<p>If both a function library and XPath expressions are provided,
the function library is used first and the expressions are only used
if the function library does not select an alternative.</p>

</div><section id="choose-function" class="section"><header><h2><span class="label">6<span class="sep">.</span>1</span><span class="sep">. </span>Using a function library</h2></header>


<p>To use a function library, you must provide an XSLT stylesheet or XQuery module
that defines a function named <code class="function">choose-alternative</code> in the
namespace <code class="uri">https://coffeepot.nineml.org/ns/functions</code>. The function must 
two parameters: an element and a map. It must return a map.
</p>

<p>Here is an example of an XSLT function library that will always select the
decimal alternative:</p>

<div class="pre-wrap programlisting-wrap"><pre class="language-xml programlisting verbatim"><code>&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
                xmlns:cp="https://coffeepot.nineml.org/ns/functions"
                exclude-result-prefixes="#all"
                version="3.0"&gt;

&lt;xsl:function name="cp:choose-alternative" as="map(*)"&gt;
  &lt;xsl:param name="context" as="element()"/&gt;
  &lt;xsl:param name="options" as="map(*)"/&gt;

  &lt;xsl:variable name="choice"
                select="$context/children[symbol[@name='decimal']]/@id"/&gt;

  &lt;xsl:sequence select="map { 'selection': $choice }"/&gt;
&lt;/xsl:function&gt;

&lt;/xsl:stylesheet&gt;
</code></pre></div>

<p>For example:</p>

<div class="pre-wrap screen-wrap"><pre class="screen verbatim"><code><code class="computeroutput">$ </code><code class="userinput">coffeepot -g:numbers.ixml -i:numbers.txt \
            --pretty-print --function-library:numbers.xsl</code>
<code class="computeroutput">Found 2 possible parses.
&lt;number-list xmlns:ixml="http://invisiblexml.org/NS" ixml:state="ambiguous"&gt;
   &lt;hex&gt;bad&lt;/hex&gt;
   &lt;hex&gt;cafe&lt;/hex&gt;
   &lt;decimal&gt;42&lt;/decimal&gt;
&lt;/number-list&gt;</code>
</code></pre></div>

<p>An alternative function library that always selects hexadecimal
could be written in XQuery this way:</p>

<div class="pre-wrap programlisting-wrap"><pre class="language-xquery programlisting verbatim"><code>module namespace f = "https://coffeepot.nineml.org/ns/functions";

declare function f:choose-alternative(
  $context as element(),
  $options as map(*)
) as map(*) {
  map {
    'selection': $context/children[symbol[@name='hex']]/@id
  }
};
</code></pre></div>

<p>For example:</p>

<div class="pre-wrap screen-wrap"><pre class="screen verbatim"><code><code class="computeroutput">$ </code><code class="userinput">coffeepot -g:numbers.ixml -i:numbers.txt \
            --pretty-print --function-library:numbers.xqy</code>
<code class="computeroutput">Found 2 possible parses.
&lt;number-list xmlns:ixml="http://invisiblexml.org/NS" ixml:state="ambiguous"&gt;
   &lt;hex&gt;bad&lt;/hex&gt;
   &lt;hex&gt;cafe&lt;/hex&gt;
   &lt;hex&gt;42&lt;/hex&gt;
&lt;/number-list&gt;</code>
</code></pre></div>

<p>For a more complete discussion of how such functions can be written and what is available
in <code>$alternatives</code>, see 
<a href="https://docs.nineml.org/current/coffeesacks/bk03ch07.html" class="link">Chapter 7. Choosing among alternatives</a>
in the <a href="https://docs.nineml.org/current/coffeesacks/" class="link">CoffeeSacks</a> documentation.</p>

</section>

<section id="choose-xpath" class="section"><header><h2><span class="label">6<span class="sep">.</span>2</span><span class="sep">. </span>Using XPath expressions</h2></header>


<p>An alternative to using a function library is to specify one or
more XPath expressions. For each place where ambiguity occurs, each
expression is evaluated with each alternative as the context item. The
first expression that has an effective boolean value of “true”, selects
the alternative to which it was applied.</p>

<p>For example:</p>

<div class="pre-wrap screen-wrap"><pre class="screen verbatim"><code><code class="computeroutput">$ </code><code class="userinput">coffeepot -g:numbers.ixml -i:numbers.txt \
            --pretty-print --choose symbol[@name='decimal']</code>
<code class="computeroutput">Found 2 possible parses.
&lt;number-list&gt;
   &lt;hex&gt;bad&lt;/hex&gt;
   &lt;hex&gt;cafe&lt;/hex&gt;
   &lt;decimal&gt;42&lt;/decimal&gt;
&lt;/number-list&gt;</code>
</code></pre></div>

<p>Observe that because a unique choice was made, the result is not marked as ambiguous.
You can override that with the <code class="option"><a href="bk02ch02.html#_strict-ambiguity">--strict-ambiguity</a></code>
option:</p>

<div class="pre-wrap screen-wrap"><pre class="screen verbatim"><code><code class="computeroutput">$ </code><code class="userinput">coffeepot -g:numbers.ixml -i:numbers.txt \
            --pretty-print --strict-ambiguity --choose symbol[@name='decimal']</code>
<code class="computeroutput">Found 2 possible parses.
&lt;number-list xmlns:ixml="http://invisiblexml.org/NS" ixml:state="ambiguous"&gt;
   &lt;hex&gt;bad&lt;/hex&gt;
   &lt;hex&gt;cafe&lt;/hex&gt;
   &lt;decimal&gt;42&lt;/decimal&gt;
&lt;/number-list&gt;</code>
</code></pre></div>

</section>
</section></main><nav class="bottom"><div class="navrow"><div class="navleft"><a title="Chapter 5. Ambiguity" href="bk02ch05.html"><i class="fas fa-arrow-left"></i></a></div><div class="navmiddle"><a title="NineML" href="../index.html"><i class="fas fa-home"></i></a></div><div class="navright"><a title="Chapter 7. Configuration" href="bk02ch07.html"><i class="fas fa-arrow-right"></i></a></div></div><div class="navrow"><div class="navleft navtitle"><a href="bk02ch05.html">Chapter <span class="label">5</span><span class="sep">. </span>Ambiguity</a></div><div class="navmiddle"><a title="CoffeePot" href="index.html"><i class="fas fa-arrow-up"></i></a></div><div class="navright navtitle"><a href="bk02ch07.html">Chapter <span class="label">7</span><span class="sep">. </span>Configuration</a></div></div><div class="infofooter"><span class="copyrightfooter">Copyright © 2022–2023 Norman Walsh.</span></div><nav class="tocopen"></nav><nav class="toc"></nav><!-- Hide ToC details from user agents that don’t support JS --><script type="text/html" class="tocopen"><i class="far fa-book"></i></script><script type="text/html" class="toc"><header><span>Table of Contents</span><span class="close"><i class="far fa-window-close"></i></span><p class="ptoc-search"><input class="ptoc-search" placeholder="Search" style="width: 80%"/></p></header><div db-persistent-toc="persistent-toc.html" db-prefix="../">Loading…</div></script></nav><script src="../js/sectmarks.js"></script></body></html>